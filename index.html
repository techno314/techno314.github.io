<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet N Truckin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: transparent; color: #f0f0f0; }
        header { background: rgba(35,39,43,0.85); padding: 1rem; text-align: center; font-size: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
        #dataDisplay { background: rgba(35,39,43,0.7); margin: 1rem; padding: 1rem; border-radius: 12px; min-height: 120px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); display:none; }
        #controls { margin: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; background: transparent; }
        .control-group { background: rgba(35,39,43,0.7); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); }
        label { display: block; margin-bottom: 0.5rem; background: transparent; font-weight: 600; letter-spacing: 0.5px; }
        input, button { margin-bottom: 0.5rem; background: rgba(24,28,32,0.5); color: #f0f0f0; border: 1px solid #444; border-radius: 6px; padding: 0.4rem 0.7rem; font-size: 1rem; transition: border 0.2s, box-shadow 0.2s; }
        input:focus, button:focus { outline: none; border: 1.5px solid #2d8cf0; box-shadow: 0 0 0 2px rgba(45,140,240,0.15); }
        button { background: rgba(45,140,240,0.5); color: #fff; border: 1px solid #2d8cf0; padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 1px 4px rgba(45,140,240,0.10); }
        button:hover { background: rgba(26,115,232,0.7); }
        #debugPanel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 20vh;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.9em;
            padding: 0.5em;
            z-index: 10000;
        }
    </style>
</head>
<body>
    </section>
    <div id="walletOverlay" style="display:none;position:fixed;top:10vh;left:10vw;width:220px;min-height:60px;max-height:30vh;background:rgba(30,30,30,0.92);color:#fff;z-index:9999;overflow:auto;padding:1rem 1.2rem;font-size:1.2rem;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,0.25);cursor:move;"></div>
    <!-- Transparency slider for wallet overlay -->
    <div id="walletTransparencyControl" style="display:none;position:fixed;top:calc(10vh + 34px);left:10vw;width:200px;height:auto;z-index:10000;padding:0.5rem 0.7rem 0.7rem 0.7rem;background:rgba(35,39,43,0.7);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.10);font-size:1em;overflow:hidden;border:1px solid black;">
        <label for="walletTransparencySlider" style="color:#fff;font-weight:600;">Transparency</label>
        <input type="range" id="walletTransparencySlider" min="0.2" max="1" step="0.01" value="0.92" style="width: calc(100% - 32px); margin: 32 0px;">
        <div id="overlayOptionsPanel" style="margin-top:0.7em;">
            <label style="color:#fff;"><input type="checkbox" id="showWallet"/> Wallet</label>
            <label style="color:#fff;"><input type="checkbox" id="showLevel"/> Level</label>
            <label style="color:#fff;"><input type="checkbox" id="showXPPercent"/> XP %</label>
            <label style="color:#fff;"><input type="checkbox" id="showRawXP"/> Raw XP</label>
            <label style="color:#fff;"><input type="checkbox" id="showBonusXP"/> Bonus XP</label>
            <label style="color:#fff;"><input type="checkbox" id="showJob"/> Job</label>
        </div>
    </div>
    <script>
        // Merged jobExpTokenMap into this file
        const jobExpTokenMap = [
          { jobName: "EMS / Paramedic", itemId: "exp_token_a|ems|ems" },
          { jobName: "Firefighter", itemId: "exp_token_a|ems|fire" },
          { jobName: "Farmer", itemId: "exp_token_a|farming|farming" },
          { jobName: "Fisherman", itemId: "exp_token_a|farming|fishing" },
          { jobName: "Miner", itemId: "exp_token_a|farming|mining" },
          { jobName: "Wildlife Hunter", itemId: "exp_token_a|hunting|skill" },
          { jobName: "Cargo Pilot", itemId: "exp_token_a|piloting|cargos" },
          { jobName: "Helicopter Pilot", itemId: "exp_token_a|piloting|heli" },
          { jobName: "Airline Pilot", itemId: "exp_token_a|piloting|piloting" },
          { jobName: "Street Racer", itemId: "exp_token_a|player|racing" },
          { jobName: "Bus Driver", itemId: "exp_token_a|train|bus" },
          { jobName: "Train Conductor", itemId: "exp_token_a|train|train" },
          { jobName: "Garbage Collector", itemId: "exp_token_a|trucking|garbage" },
          { jobName: "Mechanic", itemId: "exp_token_a|trucking|mechanic" },
          { jobName: "PostOP Driver", itemId: "exp_token_a|trucking|postop" },
          { jobName: "Trucker", itemId: "exp_token_a|trucking|trucking" }
        ];

        // --- Wallet N Truckin Overlay Script ---
        (function() {
            // Format wallet and XP values
            function formatWallet(val) {
                if (val == null || isNaN(val)) return 'N/A';
                const abs = Math.abs(val);
                if (abs >= 1e12) return (val/1e12).toFixed(2) + 't';
                if (abs >= 1e9) return (val/1e9).toFixed(2) + 'b';
                if (abs >= 1e6) return (val/1e6).toFixed(2) + 'm';
                if (abs >= 1e3) return (val/1e3).toFixed(2) + 'k';
                return val.toLocaleString();
            }
            function formatTruckingXP(xp) {
                if (xp == null || isNaN(xp)) return '0%';
                const percent = Math.max(0, Math.min(100, (xp / 1_000_000) * 100));
                return percent.toFixed(2) + '%';
            }

            // --- Add this global cache for XP data per job ---
            let jobXpCache = {};

            // --- Overlay options logic ---
            const overlayOptionsDefaults = {
                showWallet: true,
                showXPPercent: true,
                showRawXP: true,
                showBonusXP: true,
                showJob: true,
                showLevel: true // New option for Level
            };
            function getOverlayOptions() {
                let opts = {};
                try {
                    const saved = JSON.parse(localStorage.getItem('walletOverlay_options'));
                    opts = { ...overlayOptionsDefaults, ...saved };
                } catch (e) { opts = { ...overlayOptionsDefaults }; }
                return opts;
            }
            function saveOverlayOptions(opts) {
                try { localStorage.setItem('walletOverlay_options', JSON.stringify(opts)); } catch (e) {}
            }
            function updateOverlayOptionsPanel() {
                const opts = getOverlayOptions();
                document.getElementById('showWallet').checked = !!opts.showWallet;
                document.getElementById('showXPPercent').checked = !!opts.showXPPercent;
                document.getElementById('showRawXP').checked = !!opts.showRawXP;
                document.getElementById('showBonusXP').checked = !!opts.showBonusXP;
                document.getElementById('showJob').checked = !!opts.showJob;
                document.getElementById('showLevel').checked = !!opts.showLevel; // New
            }
            function listenOverlayOptionsPanel() {
                ['showWallet','showXPPercent','showRawXP','showBonusXP','showJob','showLevel'].forEach(id => {
                    document.getElementById(id).addEventListener('change', function() {
                        const opts = getOverlayOptions();
                        opts[id] = this.checked;
                        saveOverlayOptions(opts);
                        updateWalletOverlayFromDataset();
                    });
                });
            }
            function updateWalletOverlayFromDataset() {
                const overlay = document.getElementById('walletOverlay');
                let wallet = overlay.dataset.wallet ? Number(overlay.dataset.wallet) : null;
                let truckingXP = overlay.dataset.truckingXp ? Number(overlay.dataset.truckingXp) : null;
                let bonusXP = overlay.dataset.bonusXp ? Number(overlay.dataset.bonusXp) : null;
                let jobName = overlay.dataset.jobName || '';
                updateWalletOverlay(wallet, truckingXP, bonusXP, jobName);
            }

            // Update the overlay with wallet, truckingXP, and bonus XP
            function updateWalletOverlay(wallet, truckingXP, bonusXP, jobName) {
                // Only log if something actually changed (handled in message event)
                // logToDebugPanel(`updateWalletOverlay called with: wallet=${wallet}, truckingXP=${truckingXP}, bonusXP=${bonusXP}, jobName=${jobName}`);

                // Add a console log to display what the script is looking for when updating the wallet
                // console.log(`Updating wallet with values: wallet=${wallet}, truckingXP=${truckingXP}, bonusXP=${bonusXP}, jobName=${jobName}`);

                const overlay = document.getElementById('walletOverlay');
                try {
                    // Only store valid values in localStorage
                    if (wallet != null && !isNaN(wallet)) localStorage.setItem('walletOverlay_wallet', wallet);
                    if (truckingXP != null && !isNaN(truckingXP)) localStorage.setItem('walletOverlay_truckingXp', truckingXP);
                    if (bonusXP != null && !isNaN(bonusXP)) localStorage.setItem('walletOverlay_bonusXp', bonusXP);
                    if (jobName) localStorage.setItem('walletOverlay_jobName', jobName);
                } catch (e) {
                    // logToDebugPanel(`Error storing values in localStorage: ${e}`);
                }

                // Cross-reference job name with jobExpTokenMap
                let jobToken = jobName;
                if (jobName) {
                  const jobEntry = jobExpTokenMap.find(entry => entry.jobName.toLowerCase() === jobName.toLowerCase());
                  if (jobEntry) {
                    jobToken = jobEntry.itemId;
                  }
                }
                // --- Dynamically select XP field based on jobName ---
                const jobExpFieldMap = {
                    "Trucker": "exp_trucking_trucking",
                    "Mechanic": "exp_trucking_mechanic",
                    "Garbage Collector": "exp_trucking_garbage",
                    "PostOP Driver": "exp_trucking_postop",
                    "Airline Pilot": "exp_piloting_piloting",
                    "Helicopter Pilot": "exp_piloting_heli",
                    "Cargo Pilot": "exp_piloting_cargos",
                    "Bus Driver": "exp_train_bus",
                    "Train Conductor": "exp_train_train",
                    "EMS / Paramedic": "exp_ems_ems",
                    "Firefighter": "exp_ems_fire",
                    "Businesses": "exp_business_business",
                    "Street Racer": "exp_player_racing",
                    "Farmer": "exp_farming_farming",
                    "Fisherman": "exp_farming_fishing",
                    "Miner": "exp_farming_mining",
                    "Wildlife Hunter": "exp_hunting_skill",
                };
                let xpVal = null;
                if (jobName && typeof jobExpFieldMap[jobName] === "string") {
                    // Use cached XP for this job if available
                    if (typeof jobXpCache[jobName] !== "undefined") {
                        xpVal = Number(jobXpCache[jobName]);
                    } else if (lastXpData) {
                        const xpField = jobExpFieldMap[jobName];
                        if (typeof lastXpData[xpField] !== "undefined") {
                            xpVal = Number(lastXpData[xpField]);
                        }
                    }
                }
                if (xpVal == null && typeof truckingXP !== "undefined" && truckingXP !== null) {
                    xpVal = Number(truckingXP);
                }
                let xpPercent = xpVal != null && !isNaN(xpVal) ? (Math.max(0, Math.min(100, (xpVal / 1_000_000) * 100))) : 0;
                let now = Date.now();
                if (jobName !== lastXpJob || (lastXpPercent != null && xpPercent < lastXpPercent)) {
                    lastXpPercent = xpPercent;
                    lastXpPercentTimestamp = now;
                    lastXpJob = jobName;
                } else if (lastXpPercent != null && xpPercent > lastXpPercent) {
                    lastXpPercent = xpPercent;
                    lastXpPercentTimestamp = now;
                } else if (lastXpPercent == null) {
                    lastXpPercent = xpPercent;
                    lastXpPercentTimestamp = now;
                    lastXpJob = jobName;
                }
                // --- Compose overlay fields based on options ---
                const opts = getOverlayOptions();
                let fields = [];
                if (opts.showWallet) fields.push(`<b>Wallet:</b> <span style=\"font-size:1.3em;color:#7cff7c;\">${wallet != null && !isNaN(wallet) ? formatWallet(wallet) : 'N/A'}</span>`);                if (opts.showLevel) {
                    let level = (xpVal != null && !isNaN(xpVal)) ? Math.floor((Math.sqrt(1 + 8 * xpVal / 5) - 1) / 2) : null;
                    fields.push(`<b>Level:</b> <span style='font-size:1.1em;color:#b0e0e6;'>${level != null && level >= 0 ? level : 'N/A'}</span>`);
                }
                if (opts.showXPPercent) fields.push(`<b>${jobName ? jobName : 'XP'}:</b> <span style=\"font-size:1.1em;color:#8cf0ff;\">${xpPercent.toFixed(2)}%</span>`);
                if (opts.showRawXP) fields.push(`<b>Raw XP:</b> <span style='font-size:1.1em;color:#ffb347;'>${xpVal != null && !isNaN(xpVal) ? xpVal.toLocaleString() : 'N/A'}</span>`);
                if (opts.showBonusXP) fields.push(`<b>Bonus XP Left:</b> <span style='font-size:1.1em;color:#ffd700;'>${bonusXP != null && !isNaN(bonusXP) ? Number(bonusXP).toLocaleString() : 'N/A'}</span>`);
                if (opts.showJob && jobName) fields.push(`<b>Job:</b> <span style='font-size:1.1em;color:#ffa07a;'>${jobName}</span>`);
                overlay.innerHTML = fields.join('<br>');
                overlay.style.display = '';
                setOverlayAlpha(slider.value);
            }

            // --- Transparency slider logic ---
            const overlay = document.getElementById('walletOverlay');
            const transparencyControl = document.getElementById('walletTransparencyControl');
            const slider = document.getElementById('walletTransparencySlider');
            // Helper to set overlay background and text alpha (preserving color)
            function setOverlayAlpha(alpha) {
                overlay.style.background = `rgba(30,30,30,${alpha})`;
                // Update all child elements' color alpha, preserving their color
                Array.from(overlay.querySelectorAll('*')).forEach(el => {
                    if (el.tagName !== 'BR') {
                        // Get the original color from a data attribute or set it
                        let orig = el.dataset.origColor;
                        if (!orig) {
                            orig = window.getComputedStyle(el).color;
                            el.dataset.origColor = orig;
                        }
                        // Extract rgb values
                        let match = orig.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                        if (match) {
                            el.style.color = `rgba(${match[1]},${match[2]},${match[3]},${alpha})`;
                        } else {
                            // fallback for hex or named colors
                            el.style.opacity = alpha;
                        }
                    }
                });
            }
            // Restore transparency from localStorage or default
            function restoreOverlayAlpha() {
                let alpha = localStorage.getItem('walletOverlay_alpha');
                if (alpha === null) alpha = '0.92';
                slider.value = alpha;
                setOverlayAlpha(alpha);
            }
            // Save transparency to localStorage
            slider && slider.addEventListener('input', function() {
                setOverlayAlpha(this.value);
                try { localStorage.setItem('walletOverlay_alpha', this.value); } catch (e) {}
            });

            // Show/hide the slider and options with the overlay
            function showTransparencyControl() {
                transparencyControl.style.display = '';
                transparencyControl.style.left = overlay.style.left;
                transparencyControl.style.top = (parseInt(overlay.style.top, 10) + overlay.offsetHeight + 20) + 'px';
            }
            function hideTransparencyControl() {
                transparencyControl.style.display = 'none';
            }

            // --- Patch overlay drag to move slider as well ---
            function makeDraggable(overlay) {
                let isDragging = false, offsetX = 0, offsetY = 0;
                overlay.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    offsetX = e.clientX - overlay.offsetLeft;
                    offsetY = e.clientY - overlay.offsetTop;
                    overlay.style.cursor = 'grabbing';
                });
                document.addEventListener('mousemove', function(e) {
                    if (isDragging) {
                        overlay.style.left = (e.clientX - offsetX) + 'px';
                        overlay.style.top = (e.clientY - offsetY) + 'px';
                        // Move the slider with the overlay
                        transparencyControl.style.left = overlay.style.left;
                        transparencyControl.style.top = (parseInt(overlay.style.top, 10) + overlay.offsetHeight + 4) + 'px';
                    }
                });
                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        saveOverlayPosition('walletOverlay', overlay.offsetLeft, overlay.offsetTop);
                    }
                    isDragging = false;
                    overlay.style.cursor = 'move';
                });
            }

            // Save and restore overlay position
            function saveOverlayPosition(id, left, top) {
                try { localStorage.setItem('overlayPos_' + id, JSON.stringify({ left, top })); } catch (e) {}
            }
            function restoreOverlayPosition(id, el, defaultLeft, defaultTop) {
                try {
                    const pos = JSON.parse(localStorage.getItem('overlayPos_' + id));
                    if (pos && typeof pos.left === 'number' && typeof pos.top === 'number') {
                        el.style.left = pos.left + 'px';
                        el.style.top = pos.top + 'px';
                    } else {
                        el.style.left = defaultLeft;
                        el.style.top = defaultTop;
                    }
                } catch (e) {
                    el.style.left = defaultLeft;
                    el.style.top = defaultTop;
                }
            }

            // Extract wallet, XP, and bonus XP from incoming messages
            let lastJobName = null; // Track last known job name
            let lastInventoryObj = null; // Cache the last inventory object

            function extractOverlayData(event) {
                let wallet = null, truckingXP = null, bonusXP = null, jobName = null;
                let jobChanged = false;
                // --- Cache the latest XP data if present ---
                if (event.data && event.data.type === 'data' && event.data.fromTycoonScript && event.data.data) {
                    const data = event.data.data;
                    // If any exp_ field is present, update the cache
                    for (const k of [
                        "exp_trucking_mechanic","exp_piloting_cargos","exp_farming_mining","exp_business_business",
                        "exp_trucking_garbage","exp_trucking_trucking","exp_ems_ems","exp_player_racing",
                        "exp_train_bus","exp_ems_fire","exp_train_train","exp_trucking_postop","exp_piloting_heli",
                        "exp_business_faction","exp_farming_farming","exp_farming_fishing","exp_hunting_skill",
                        "exp_piloting_piloting"
                    ]) {
                        if (typeof data[k] !== "undefined") {
                            lastXpData = data;
                            // --- Cache XP data for each job ---
                            for (const job in jobExpFieldMap) {
                                const xpField = jobExpFieldMap[job];
                                if (typeof data[xpField] !== "undefined") {
                                    jobXpCache[job] = data[xpField];
                                }
                            }
                            break;
                        }
                    }
                }
                if (event.data && event.data.type === 'data' && event.data.fromTycoonScript && event.data.data) {
                    const data = event.data.data;
                    wallet = data.wallet ?? null;
                    truckingXP = data.exp_trucking_trucking ?? data.truckingXP ?? null;

                    // Only update jobName if present in incoming data
                    if (typeof data.job_name !== "undefined" || typeof data.job_title !== "undefined") {
                        jobName = data.job_name ?? data.job_title ?? null;
                        if (jobName !== lastJobName) {
                            // logToDebugPanel(`Job title updated to: ${jobName}`);
                            jobChanged = true;
                            lastJobName = jobName;
                        }
                    } else {
                        // Use last known job name if not present in this message
                        jobName = lastJobName;
                    }

                    // Parse inventory for bonus XP and cache it
                    let inventoryObj = null;
                    if (data.inventory) {
                        if (typeof data.inventory === 'string') {
                            try { inventoryObj = JSON.parse(data.inventory); } catch (e) { inventoryObj = null; }
                        } else if (typeof data.inventory === 'object') {
                            inventoryObj = data.inventory;
                        }
                        if (inventoryObj) {
                            lastInventoryObj = inventoryObj;
                        }
                    }
                    // Use cached inventory if not present in this message
                    if (!inventoryObj && lastInventoryObj) {
                        inventoryObj = lastInventoryObj;
                    }

                    // If job changed, pull bonusXP from cached inventory
                    if (inventoryObj) {
                        let found = false;
                        let lastBonusXP = null;
                        if (jobName) {
                          const jobEntry = jobExpTokenMap.find(entry => entry.jobName.toLowerCase() === jobName.toLowerCase());
                          if (jobEntry) {
                            const itemName = jobEntry.itemId;
                            for (const key in inventoryObj) {
                                if (key.toLowerCase() === itemName.toLowerCase()) {
                                    const item = inventoryObj[key];
                                    if (item && typeof item.amount === 'number') {
                                        lastBonusXP = item.amount;
                                        if (bonusXP !== lastBonusXP) {
                                            bonusXP = item.amount;
                                            // logToDebugPanel(`Matched job token: ${itemName} with bonusXP=${bonusXP}`);
                                        }
                                        found = true;
                                        break;
                                    }
                                }
                            }
                          } else {
                            // logToDebugPanel(`No matching job found in jobExpTokenMap for jobName: ${jobName}`);
                            // Do NOT fallback to any token if jobName is present but not mapped
                          }
                        }
                        // Only log fallback check if not found or jobName changed
                        if (!found || jobChanged) {
                            // logToDebugPanel(`Fallback check: found=${found}, jobName=${jobName}`);
                        }
                        // Fallback: only if jobName is missing/empty AND no match was found
                        if (!found && !jobName) {
                          // logToDebugPanel('Running fallback: jobName is missing/empty and no match was found.');
                          for (const key in inventoryObj) {
                            if (/^exp_token_a\|/i.test(key)) {
                              const item = inventoryObj[key];
                              if (item && typeof item.amount === 'number') {
                                bonusXP = item.amount;
                                // logToDebugPanel(`Fallback: Found bonusXP=${bonusXP} for key=${key}`);
                                break;
                              }
                            }
                          }
                        } else if (!found && jobName) {
                          // logToDebugPanel('No bonusXP found for mapped job, and fallback is NOT run because jobName is present.');
                          // Set bonusXP to 0 if not found for mapped job and fallback is not run
                          bonusXP = 0;
                        }
                    }
                }
                return { wallet, truckingXP, bonusXP, jobName };
            }
            // Restore overlay and values on page load
            window.addEventListener('DOMContentLoaded', function() {
                const overlay = document.getElementById('walletOverlay');
                restoreOverlayPosition('walletOverlay', overlay, '10vw', '10vh');
                makeDraggable(overlay);

                // Restore values from localStorage
                let wallet = localStorage.getItem('walletOverlay_wallet');
                let truckingXP = localStorage.getItem('walletOverlay_truckingXp');
                let bonusXP = localStorage.getItem('walletOverlay_bonusXp');
                wallet = wallet !== null ? Number(wallet) : null;
                truckingXP = truckingXP !== null ? Number(truckingXP) : null;
                bonusXP = bonusXP !== null ? Number(bonusXP) : null;

                // Update dataset attributes for fallback
                overlay.dataset.wallet = wallet != null ? wallet : '';
                overlay.dataset.truckingXp = truckingXP != null ? truckingXP : '';
                overlay.dataset.bonusXp = bonusXP != null ? bonusXP : '';

                // Do not hide the overlay; rely on message events for updates
                if (wallet != null || truckingXP != null || bonusXP != null) {
                    updateWalletOverlay(wallet, truckingXP, bonusXP);
                    overlay.style.display = '';
                }
                restoreOverlayAlpha();
                // Show the slider if overlay is visible
                if (overlay.style.display !== 'none') {
                    showTransparencyControl();
                }
                updateOverlayOptionsPanel();
                listenOverlayOptionsPanel();
            });

            // Check if jobExpTokenMap is loaded
            if (typeof jobExpTokenMap === 'undefined') {
                // logToDebugPanel('Error: jobExpTokenMap is not loaded.');
            } else {
                // logToDebugPanel('jobExpTokenMap loaded successfully.');
            }

            // Track focus state globally
            let overlayIsFocused = false;

            // Refine message listener to ensure it updates the overlay correctly
            window.addEventListener('message', (event) => {
                const overlay = document.getElementById('walletOverlay');

                // Recursively search for "focused": true/false in event.data
                function findFocused(obj) {
                    if (!obj || typeof obj !== 'object') return null;
                    if (Object.prototype.hasOwnProperty.call(obj, 'focused')) {
                        return obj.focused;
                    }
                    for (const key in obj) {
                        if (typeof obj[key] === 'object') {
                            const result = findFocused(obj[key]);
                            if (typeof result === 'boolean') return result;
                        }
                    }
                    return null;
                }

                // Only process messages that contain a focused property
                const focusResult = findFocused(event.data);
                if (typeof focusResult === 'boolean') {
                    overlayIsFocused = focusResult;
                    if (overlayIsFocused) {
                        showTransparencyControl();
                    } else {
                        hideTransparencyControl();
                    }
                }
                // Do NOT show/hide the slider for any other message

                // Extract wallet, XP, and bonus XP from incoming data
                const { wallet, truckingXP, bonusXP, jobName } = extractOverlayData(event);

                // Only log jobName if it changed
                if (jobName !== overlay.dataset.jobName) {
                    // logToDebugPanel(`Received jobName: ${jobName}`);
                }

                // Only log updateWalletOverlay invocation if jobName, wallet, truckingXP, or bonusXP changed
                const currentWallet = wallet != null ? wallet : (overlay.dataset.wallet ? Number(overlay.dataset.wallet) : null);
                const currentTruckingXP = truckingXP != null ? truckingXP : (overlay.dataset.truckingXp ? Number(overlay.dataset.truckingXp) : null);
                const currentBonusXP = bonusXP != null ? bonusXP : (overlay.dataset.bonusXp ? Number(overlay.dataset.bonusXp) : null);
                const currentJobName = jobName || overlay.dataset.jobName || '';

                const prevWallet = overlay.dataset.wallet ? Number(overlay.dataset.wallet) : null;
                const prevTruckingXP = overlay.dataset.truckingXp ? Number(overlay.dataset.truckingXp) : null;
                const prevBonusXP = overlay.dataset.bonusXp ? Number(overlay.dataset.bonusXp) : null;
                const prevJobName = overlay.dataset.jobName || '';

                const shouldUpdate =
                    currentWallet !== prevWallet ||
                    currentTruckingXP !== prevTruckingXP ||
                    currentBonusXP !== prevBonusXP ||
                    currentJobName !== prevJobName;

                if (wallet != null || truckingXP != null || bonusXP != null || jobName) {
                    if (shouldUpdate) {
                        // logToDebugPanel(`Invoking updateWalletOverlay with jobName: ${currentJobName}`);
                    }
                    // Update the overlay dynamically
                    updateWalletOverlay(currentWallet, currentTruckingXP, currentBonusXP, currentJobName);

                    // Update dataset attributes for fallback
                    overlay.dataset.wallet = currentWallet != null ? currentWallet : '';
                    overlay.dataset.truckingXp = currentTruckingXP != null ? currentTruckingXP : '';
                    overlay.dataset.bonusXp = currentBonusXP != null ? currentBonusXP : '';
                    overlay.dataset.jobName = currentJobName;

                    // Ensure the overlay is visible
                    overlay.style.display = '';
                }
            });

            // Hide slider if overlay is hidden (optional, not strictly needed)
            // window.addEventListener('resize', () => {
            //     const overlay = document.getElementById('walletOverlay');
            //     if (overlay.style.display === 'none') {
            //         hideTransparencyControl();
            //     } else {
            //         showTransparencyControl();
            //     }
            // });

            // Pin the window (return control to game) on Escape
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    window.parent.postMessage({type: 'pin'}, '*');
                }
            });
        })();
    </script>
</body>
</html>
